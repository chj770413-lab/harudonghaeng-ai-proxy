// ----------------------------
// CORS ì„¤ì •
// ----------------------------
const CORS_HEADERS = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type",
};

// ----------------------------
// ì‘ë‹µ í—¬í¼
// ----------------------------
function sendResponse(res, status, body) {
  res.status(status).setHeader("Content-Type", "application/json");
  for (const key in CORS_HEADERS) {
    res.setHeader(key, CORS_HEADERS[key]);
  }
  res.send(JSON.stringify(body));
}

// ----------------------------
// ë©”ì¸ í•¸ë“¤ëŸ¬ (ë¬´ìƒíƒœ)
// ----------------------------
export default async function handler(req, res) {
  if (req.method === "OPTIONS") {
    for (const key in CORS_HEADERS) {
      res.setHeader(key, CORS_HEADERS[key]);
    }
    return res.status(200).end();
  }

  if (req.method !== "POST") {
    return sendResponse(res, 405, { error: "POST ìš”ì²­ë§Œ í—ˆìš©ë©ë‹ˆë‹¤." });
  }

  // ğŸ‘‡ lastMessageë¥¼ í•¨ê»˜ ë°›ìŒ (Aë‹¨ê³„ í•µì‹¬)
  const { message, lastMessage } = req.body || {};
  if (!message) {
    return sendResponse(res, 400, { error: "message íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤." });
  }

  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    return sendResponse(res, 500, { error: "OPENAI_API_KEYê°€ ì—†ìŠµë‹ˆë‹¤." });
  }

  try {
   // ----------------------------
// í•˜ë£¨ë™í–‰ SYSTEM PROMPT
// ----------------------------
const systemPrompt = `
ë‹¹ì‹ ì€ 'í•˜ë£¨ë™í–‰'ì´ë¼ëŠ” ì‹œë‹ˆì–´ ê±´ê°• ë„ìš°ë¯¸ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì—­í• ì€ â€˜ëŒ€ë‹µë§Œ í•˜ëŠ” AIâ€™ê°€ ì•„ë‹ˆë¼,
â€˜ë§ì„ ì˜ ë“£ê³ , í•µì‹¬ë§Œ ì •ë¦¬í•´ ì£¼ë©°, ë‹¤ìŒì„ ì•ˆë‚´í•˜ëŠ” ê°„í˜¸ì‚¬â€™ì…ë‹ˆë‹¤.

[ê¸°ë³¸ ë§íˆ¬ ì›ì¹™]
1. ì²« ë¬¸ì¥ì€ í•­ìƒ 1~2ë¬¸ì¥ìœ¼ë¡œ ì§§ê³  ë”°ëœ»í•˜ê²Œ ì‹œì‘í•©ë‹ˆë‹¤.
2. ì „ë¬¸ ìš©ì–´, ì¥í™©í•œ ì„¤ëª…, ì˜ì‚¬ì²˜ëŸ¼ ë‹¨ì •í•˜ëŠ” í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
3. ì‚¬ìš©ìê°€ â€œë‚´ ë§ì„ ì´í•´ë°›ê³  ìˆë‹¤â€ê³  ëŠë¼ëŠ” íë¦„ì„ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤.

[ëŒ€í™” ìš”ì•½ ê·œì¹™ â€“ ì¤‘ìš”]
4. ì´ì „ ëŒ€í™”ê°€ ìˆì„ ê²½ìš°,
   **í˜„ì¬ ì§ˆë¬¸ê³¼ ì§ì ‘ ê´€ë ¨ëœ ì •ë³´ë§Œ** í•œ ë²ˆ ì§šìŠµë‹ˆë‹¤.
5. ì´ë¯¸ ê³µê°Â·í™•ì¸ëœ ë°°ê²½ ì„¤ëª…(ì‚¬ì—°, ê³„ê¸°, ë‹¤ë¥¸ ì‚¬ëŒ ì´ì•¼ê¸°)ì€
   ë‹¤ì‹œ ìš”ì•½í•˜ê±°ë‚˜ ë°˜ë³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
6. ê°™ì€ ì¦ìƒ, ê°™ì€ ë°°ê²½, ê°™ì€ ì´ìœ ì— ëŒ€í•œ
   ê³µê° ë¬¸ì¥ì´ë‚˜ ì‚¬ì‹¤ ì„¤ëª…ì€ ë°˜ë³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

[ëŒ€í™” ë‹¨ê³„ ì¸ì‹ ê·œì¹™ â€“ ë§¤ìš° ì¤‘ìš”]
7. ëŒ€í™”ëŠ” ë‹¤ìŒ ë‹¨ê³„ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì§„í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
   (ê³„ê¸° â†’ ì¦ìƒ â†’ ê²€ì‚¬/ì •ë³´ â†’ ê´€ë¦¬/ì„ íƒ)
8. í•œ ë‹¨ê³„ê°€ ì§€ë‚˜ê°”ë‹¤ë©´,
   ì´ì „ ë‹¨ê³„ì˜ ë‚´ìš©ì€ ë‹¤ì‹œ ì–¸ê¸‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
9. ì´ë¯¸ í•œ ì§ˆë¬¸ì€ ë‹¤ì‹œ ë¬»ì§€ ì•ŠìŠµë‹ˆë‹¤.
10. ì‚¬ìš©ìê°€ ì£¼ì œë¥¼ ë°”ê¾¸ë©´, ê·¸ íë¦„ì„ ì¡´ì¤‘í•´ ìì—°ìŠ¤ëŸ½ê²Œ ë”°ë¼ê°‘ë‹ˆë‹¤.

[A++ ìƒë‹´ ê·œì¹™]
11. ì§ˆë¬¸ë§Œ ë˜ì§€ì§€ ë§ê³ ,
    ì§§ì€ â€˜ì¤‘ê°„ íŒë‹¨â€™ ë˜ëŠ” â€˜ì •ë¦¬ ë¬¸ì¥â€™ì„ í•¨ê»˜ ì œì‹œí•©ë‹ˆë‹¤.
12. íŒë‹¨ì€ ë‹¨ì •í•˜ì§€ ì•Šê³  ì™„ê³¡í•˜ê²Œ í‘œí˜„í•©ë‹ˆë‹¤.
    (ì˜ˆ: "ì§€ê¸ˆ ë‹¨ê³„ì—ì„œëŠ” í¬ê²Œ ê±±ì •í•  ì‹ í˜¸ëŠ” ì—†ì–´ ë³´ì…ë‹ˆë‹¤",
         "ê¸‰í•´ ë³´ì´ì§€ëŠ” ì•Šì§€ë§Œ í™•ì¸í•´ ë³¼ ìˆ˜ëŠ” ìˆê² ìŠµë‹ˆë‹¤")
13. ì´í›„ì—ëŠ” í•œ ê°€ì§€ ë°©í–¥ì˜ ì§ˆë¬¸ ë˜ëŠ” ê°€ì´ë“œë¥¼ ì œì‹œí•©ë‹ˆë‹¤.

[ì •ë³´ ë¬¸ì˜ ì˜ˆì™¸ ê·œì¹™]
14. ê²€ì‚¬, ê±´ê°•ê²€ì§„, ì´ˆìŒíŒŒ, ë‚´ì‹œê²½ ë“±
    â€˜ì •ë³´ë¥¼ ë¬»ëŠ” ì§ˆë¬¸â€™ì—ëŠ”
    ìœ„í—˜ ì—¬ë¶€ íŒë‹¨ì´ë‚˜ ë¶ˆì•ˆê°ì„ ì£¼ëŠ” í‘œí˜„ì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
15. ì‚¬ìš©ìê°€ í•©ë¦¬ì ì¸ ê²€ì‚¬ë‚˜ ê±´ê°• ê´€ë¦¬ ì œì•ˆì„ í•˜ë©´,
    ì´ë¥¼ ë¨¼ì € ì¸ì •í•˜ê³  ê°„ë‹¨í•œ ì´ìœ ë¥¼ ì„¤ëª…í•œ ë’¤ ì§ˆë¬¸ì„ ì´ì–´ê°‘ë‹ˆë‹¤.

[ëª©í‘œ]
- ì‚¬ìš©ìê°€ â€œì•„, ì´ ì‚¬ëŒì€ ë‚´ ë§ì„ ê¸°ì–µí•˜ê³ 
  ê°™ì€ ë§ì„ ë°˜ë³µí•˜ì§€ ì•Šë„¤â€ë¼ê³  ëŠë¼ê²Œ í•˜ì„¸ìš”.
- ëŒ€í™”ê°€ ì œìë¦¬ì—ì„œ ë§´ëŒì§€ ì•Šê³ ,
  í•­ìƒ ë‹¤ìŒ ë‹¨ê³„ë¡œ í•œ ê±¸ìŒ ë‚˜ì•„ê°€ê²Œ í•˜ì„¸ìš”.
`;
 



    // ----------------------------
    // ë©”ì‹œì§€ êµ¬ì„± (Aë‹¨ê³„: ì§ì „ ì§ˆë¬¸ 1ê°œ)
    // ----------------------------
    const messages = [
      { role: "system", content: systemPrompt },
    ];

    // ğŸ‘‡ ì§ì „ ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ì¶”ê°€
    if (lastMessage) {
      messages.push({ role: "user", content: lastMessage });
    }

    // í˜„ì¬ ì§ˆë¬¸
    messages.push({ role: "user", content: message });

    // ----------------------------
    // OpenAI í˜¸ì¶œ
    // ----------------------------
    const openaiRes = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        temperature: 0.4,
        messages,
      }),
    });

    const data = await openaiRes.json();

    if (!openaiRes.ok) {
      return sendResponse(res, 500, {
        error: "OpenAI API ì˜¤ë¥˜",
        details: data,
      });
    }

    const reply =
      data.choices?.[0]?.message?.content ||
      "ë§ì”€í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ì¡°ê¸ˆ ë” ì•Œë ¤ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”?";

    return sendResponse(res, 200, { reply });
  } catch (err) {
    return sendResponse(res, 500, {
      error: "ì„œë²„ ì˜¤ë¥˜",
      details: err.toString(),
    });
  }
}
